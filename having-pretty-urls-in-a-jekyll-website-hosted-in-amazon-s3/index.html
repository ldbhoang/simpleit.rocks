<!DOCTYPE html>
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <link rel="alternate" type="application/rss+xml" title="Simple IT 🤘 Rocks" href="https://simpleit.rocks/feed.xml">

    <meta name="msvalidate.01" content="453BB779294406F41BD202E3E24FFE55" />

    <!-- Fontawesome -->
    <link rel="stylesheet" href="/assets/vendor/font-awesome.min.css" type="text/css" media="screen" />

    
    
    
    <!-- Custom css -->
    <link rel="stylesheet" href="/css/main.css">

    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://simpleit.rocks/assets/favicons/apple-touch-icon-57x57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://simpleit.rocks/assets/favicons/apple-touch-icon-114x114.png" />
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://simpleit.rocks/assets/favicons/apple-touch-icon-72x72.png" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://simpleit.rocks/assets/favicons/apple-touch-icon-144x144.png" />
<link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://simpleit.rocks/assets/favicons/apple-touch-icon-60x60.png" />
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://simpleit.rocks/assets/favicons/apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://simpleit.rocks/assets/favicons/apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://simpleit.rocks/assets/favicons/apple-touch-icon-152x152.png" />
<link rel="icon" type="image/png" href="https://simpleit.rocks/assets/favicons/favicon-196x196.png" sizes="196x196" />
<link rel="icon" type="image/png" href="https://simpleit.rocks/assets/favicons/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/png" href="https://simpleit.rocks/assets/favicons/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="https://simpleit.rocks/assets/favicons/favicon-16x16.png" sizes="16x16" />
<link rel="icon" type="image/png" href="https://simpleit.rocks/assets/favicons/favicon-128.png" sizes="128x128" />
<meta name="application-name" content="Simple IT ROCKS"/>
<meta name="msapplication-TileColor" content="#FFFFFF" />
<meta name="msapplication-TileImage" content="https://simpleit.rocks/assets/favicons/mstile-144x144.png" />
<meta name="msapplication-square70x70logo" content="https://simpleit.rocks/assets/favicons/mstile-70x70.png" />
<meta name="msapplication-square150x150logo" content="https://simpleit.rocks/assets/favicons/mstile-150x150.png" />
<meta name="msapplication-wide310x150logo" content="https://simpleit.rocks/assets/favicons/mstile-310x150.png" />
<meta name="msapplication-square310x310logo" content="https://simpleit.rocks/assets/favicons/mstile-310x310.png" />
<meta name="msapplication-notification" content="frequency=30;polling-uri=http://notifications.buildmypinnedsite.com/?feed=https://simpleit.rocks/feed&amp;id=1;polling-uri2=http://notifications.buildmypinnedsite.com/?feed=https://simpleit.rocks/feed&amp;id=2;polling-uri3=http://notifications.buildmypinnedsite.com/?feed=https://simpleit.rocks/feed&amp;id=3;polling-uri4=http://notifications.buildmypinnedsite.com/?feed=https://simpleit.rocks/feed&amp;id=4;polling-uri5=http://notifications.buildmypinnedsite.com/?feed=https://simpleit.rocks/feed&amp;id=5;cycle=1" />


    
  <!-- Begin Jekyll SEO tag v2.2.3 -->
<title>Host a Jekyll Website With Pretty Urls In Amazon S3 and Cloudfront | Simple IT 🤘 Rocks</title>
<meta property="og:title" content="Host a Jekyll Website With Pretty Urls In Amazon S3 and Cloudfront" />
<meta name="author" content="marcanuy" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How to host and deploy a Jekyll website to AWS S3 having its URLs without extensions (.html)" />
<meta property="og:description" content="How to host and deploy a Jekyll website to AWS S3 having its URLs without extensions (.html)" />
<link rel="canonical" href="https://simpleit.rocks/having-pretty-urls-in-a-jekyll-website-hosted-in-amazon-s3/" />
<meta property="og:url" content="https://simpleit.rocks/having-pretty-urls-in-a-jekyll-website-hosted-in-amazon-s3/" />
<meta property="og:site_name" content="Simple IT 🤘 Rocks" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-04-24T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@simpleitrocks" />
<meta name="twitter:creator" content="@marcanuy" />
<meta property="fb:app_id" content="1822851531277021" />
<script type="application/ld+json">
{"@context":"http://schema.org","@type":"BlogPosting","headline":"Host a Jekyll Website With Pretty Urls In Amazon S3 and Cloudfront","author":{"@type":"Person","name":"marcanuy"},"datePublished":"2017-04-24T00:00:00+00:00","dateModified":"2017-04-24T00:00:00+00:00","description":"How to host and deploy a Jekyll website to AWS S3 having its URLs without extensions (.html)","mainEntityOfPage":{"@type":"WebPage","@id":"https://simpleit.rocks/having-pretty-urls-in-a-jekyll-website-hosted-in-amazon-s3/"},"url":"https://simpleit.rocks/having-pretty-urls-in-a-jekyll-website-hosted-in-amazon-s3/"}</script>
<!-- End Jekyll SEO tag -->


  

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-1912030305535489",
    enable_page_level_ads: true
  });
</script>



</head>


  <body>

    

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-28572639-2', 'auto');
  ga('send', 'pageview');

</script>



    <header class="site-header">

    

    <div class="mb-2 text-center">

	<a class="display-1" href="/" style="text-decoration: none">Simple IT 🤘 Rocks</a>

    </div>

    
    <div class="jumbotron jumbotron-fluid bg-inverse">
  <div class="container">
    
    
    
    
    
    <h1 class="title">Host A Jekyll Website With Pretty Urls In Amazon S3 And Cloudfront </h1>
    
    
  </div>
</div>

    

</header>


    <div class="container-fluid">
      <header class="post-header">
  <div>
    <div class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList" class="list-/inline breadcrumb">

    
    
    
    


<li itemprop="itemListElement" itemscope
    itemtype="https://schema.org/ListItem"
    class="breadcrumb-item">
  
  <a itemscope itemtype="https://schema.org/Thing"
     itemprop="item" href="/">
    
    <i class="fa fa-home" aria-hidden="true"></i>
    

    Home
  </a>
  
  <meta itemprop="position" content="1" />
</li>

    
    

    
    
    
    
    
    
    
    


<li itemprop="itemListElement" itemscope
    itemtype="https://schema.org/ListItem"
    class="breadcrumb-item">
  
  <a itemscope itemtype="https://schema.org/Thing"
     itemprop="item" href="/docs">
    

    docs
  </a>
  
  <meta itemprop="position" content="2" />
</li>

    

    
    
    
    
    
    


<li itemprop="itemListElement" itemscope
    itemtype="https://schema.org/ListItem"
    class="breadcrumb-item">
  
  <a itemscope itemtype="https://schema.org/Thing"
     itemprop="item" href="/docs/ruby">
    

    ruby
  </a>
  
  <meta itemprop="position" content="3" />
</li>

    

    
    
    
    
    
    


<li itemprop="itemListElement" itemscope
    itemtype="https://schema.org/ListItem"
    class="breadcrumb-item">
  
  <a itemscope itemtype="https://schema.org/Thing"
     itemprop="item" href="/docs/ruby/jekyll">
    

    jekyll
  </a>
  
  <meta itemprop="position" content="4" />
</li>

    

    
    
    
    
    
    


<li itemprop="itemListElement" itemscope
    itemtype="https://schema.org/ListItem"
    class="breadcrumb-item">
  
  <a itemscope itemtype="https://schema.org/Thing"
     itemprop="item" href="/docs/ruby/jekyll/tutorials">
    

    tutorials
  </a>
  
  <meta itemprop="position" content="5" />
</li>

    

    
    
    
    
    
    


<li itemprop="itemListElement" itemscope
    itemtype="https://schema.org/ListItem"
    class="breadcrumb-item active">
  
  <span itemscope itemtype="https://schema.org/Thing"
       itemprop="item">
    

    <span itemprop="name">Host a Jekyll Website With Pretty Urls In Amazon S3 and Cloudfront</span>
  </span>
  
  <meta itemprop="position" content="6" />
</li>

    

    
    
  </ol>
</div>

  </div>
</header>

<div class="post-content" itemprop="articleBody">
  <div class="row">

  <div class="col-md-3 site-sidebar">
    <div class="si-ad m-1 mx-auto">
  

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- simpleit_side_content -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-1912030305535489"
       data-ad-slot="5882730780"
       data-ad-format="auto"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  
  
</div>

    
    <div class="sticky" style="position:sticky; top:10px">
      <div>
	<h4>Table of Contents</h4>
	<ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#overview">Overview</a></li>
<li class="toc-entry toc-h2"><a href="#remove-extension-from-files-before-deploying">Remove extension from files before deploying</a></li>
<li class="toc-entry toc-h2"><a href="#upload-files">Upload files</a></li>
<li class="toc-entry toc-h3"><a href="#copy-files-without-extension">Copy files without extension</a></li>
<li class="toc-entry toc-h3"><a href="#copy-the-rest-of-the-files">Copy the rest of the files</a></li>
<li class="toc-entry toc-h2"><a href="#invalidate-uploaded-files-in-cloudfront">Invalidate uploaded files in Cloudfront</a></li>
<li class="toc-entry toc-h3"><a href="#script-explanation">Script explanation:</a></li>
<li class="toc-entry toc-h2"><a href="#final-script">Final script</a></li>
<li class="toc-entry toc-h2"><a href="#conclusion">Conclusion</a></li>
<li class="toc-entry toc-h2"><a href="#references">References</a></li>
</ul>
      </div>
      <div>
	<div class="site-share pb-2">
  
  <ul class="share-buttons list-inline mb-1 text-center">
    <li class="list-inline-item">
      <div>
    <a class="twitter-share-button"
       href="https://twitter.com/share"
       data-url="https://simpleit.rocks/having-pretty-urls-in-a-jekyll-website-hosted-in-amazon-s3/"
       data-via=""
       data-text="Host a Jekyll Website With Pretty Urls In Amazon S3 and Cloudfront"
       data-related="marcanuy,simpleitrocks"
       data-count="vertical">
	Tweet
    </a>
    <script>
     window.twttr=(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return;js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);t._e=[];t.ready=function(f){t._e.push(f);};return t;}(document,"script","twitter-wjs"));
    </script>
</div>

    </li>
    <li class="list-inline-item">
      <div>
  <!-- Place this tag in your head or just before your close body tag. -->
  <script src="https://apis.google.com/js/platform.js" async defer></script>

  <!-- Place this tag where you want the +1 button to render. -->
  <div class="g-plusone" data-size="tall"></div>
</div>

    </li>
    <li class="list-inline-item">
      <div>
  <div id="fb-root"></div>
  <script>(function(d, s, id) {
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) return;
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.0";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));</script>

  <div class="fb-like" data-href="https://simpleit.rocks/having-pretty-urls-in-a-jekyll-website-hosted-in-amazon-s3/" data-layout="box_count" data-action="like" data-show-faces="false" data-share="true"></div>
</div>

    </li>
  </ul>
  
</div>

      </div>
    </div>
    
  </div> <!-- end col -->

  <div class="col-md-8 site-content">

    
	<p class="lead">
	  How to host and deploy a Jekyll website to AWS S3 having its URLs without extensions (.html)
	</p>
    

    <div class="si-ad m-3 mx-auto">
  

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- simpleit_before_content -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-1912030305535489"
       data-ad-slot="2929264389"
       data-ad-format="auto"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>

  
</div>


    <h2 id="overview">Overview</h2>

<p>One of the problems in having pretty URLs when hosting a Jekyll site
in Amazon S3, is that even we set <code class="highlighter-rouge">permalinks</code> URLs without <code class="highlighter-rouge">.html</code>
extensions, the files generated by Jekyll include this extension.</p>

<p>It relies on the server configuration to be able to detect its
content-type<sup id="fnref:contenttype"><a href="#fn:contenttype" class="footnote">1</a></sup> so it can handle URLs that does not include the <code class="highlighter-rouge">.html</code>
extension, and serve the corresponding file.</p>

<p>Amazon S3 isn’t able to make this translation, so it leaves us with
two options to have URLs without ending in <code class="highlighter-rouge">.html</code>:</p>

<ul>
  <li>
    <p>Create each post in Jekyll as a <code class="highlighter-rouge">(directory)/index.html</code> file, so it
will serve each <code class="highlighter-rouge">index.html</code>. E.g.:</p>

    <p>We try to access <code class="highlighter-rouge">https://example.com/my-cool-page</code>, then Amazon S3
  server will be able to respond to this request if it finds one of
  these files:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  /my-cool-page/index.html
</code></pre>
    </div>
  </li>
</ul>

<p>Or</p>

<ul>
  <li>
    <p>Generate HTML files without the extension:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  /my-cool-page
</code></pre>
    </div>
  </li>
</ul>

<p>Also, the <strong>Content-type</strong> header of extension-less files should be
set to <code class="highlighter-rouge">text/html</code> after renaming them.</p>

<h2 id="remove-extension-from-files-before-deploying">Remove extension from files before deploying</h2>

<p>If configuring Jekyll to generate posts/pages in subdirectories is not
an option, then we can remove the <code class="highlighter-rouge">.html</code> extension to all the files,
<strong>except</strong> those named <code class="highlighter-rouge">index.html</code>, just before deploying them
to the server.</p>

<p>An easy way to do it is to have a shell script that removes them after
building the site.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>find _site/ -type f ! -iname <span class="s1">'index.html'</span> -iname <span class="s1">'*.html'</span> -print0 | <span class="k">while </span><span class="nb">read</span> -d <span class="nv">$'</span><span class="se">\0</span><span class="s1">' f; do mv "$f" "${f%.html}"; done
</span></code></pre>
</div>

<p>Command explanation:</p>

<dl class="row"> 
<dt class="col-sm-3">-type f</dt> 
<dd class="col-sm-9">
File is of type "regular file"
</dd> 
<dt class="col-sm-3">! -iname 'index.html'</dt> 
<dd class="col-sm-9">
Avoid matching index.html files.
</dd> 
<dt class="col-sm-3">-iname pattern</dt> 
<dd class="col-sm-9">
<blockquote>Base of file name (the path with the leading directories
removed) matches shell pattern pattern.</blockquote> Case insensitive
</dd> 
<dt class="col-sm-3">-print0</dt> 
<dd class="col-sm-9">
<blockquote>True;  print the full file name on the standard output, followed by a
null character (instead of the newline character that -print uses).
This allows file names that contain newlines or other types of white
space to be correctly interpreted by programs that process the find
output. This option corresponds to the -0 option of xargs.</blockquote>
</dd> 
<dt class="col-sm-3">read -d delimiter</dt> 
<dd class="col-sm-9">
<blockquote>The first character of DELIM is used to terminate the input line, rather than newline.</blockquote>
</dd> 
</dl>

<p>Example:</p>

<pre class="shell">
<samp>
<span class="shell-prompt">$</span> <kbd>jekyll build</kbd>
Configuration file: /tmp/j/_config.yml
            Source: /tmp/j
       Destination: /tmp/j/_site
 Incremental build: disabled. Enable with --incremental
      Generating... 
                    done in 1.433 seconds.
<span class="shell-prompt">$</span> <kbd>tree _site/</kbd>
_site/
|-- about
|   `-- index.html
|-- assets
|   `-- main.css
|-- feed.xml
|-- index.html
`-- jekyll
    `-- update
        `-- 2017
            `-- 04
                `-- 24
                    `-- welcome-to-jekyll.html

7 directories, 5 files
<span class="shell-prompt">$</span> <kbd>find _site/ -type f ! -iname 'index.html' -iname '*.html' -print0 | while read -d $'\0' f; do mv "$f" "${f%.html}"; done</kbd>
<span class="shell-prompt">$</span> <kbd>tree _site/</kbd>
_site/
├── about
│   └── index.html
├── assets
│   └── main.css
├── feed.xml
├── index.html
└── jekyll
    └── update
        └── 2017
            └── 04
                └── 26
                    └── welcome-to-jekyll

7 directories, 5 files
</samp>
</pre>

<h2 id="upload-files">Upload files</h2>

<p>When uploading the files to the server we must set the correct MIME
type to <code class="highlighter-rouge">Content-Type: text/html</code> to the files that does not have
<code class="highlighter-rouge">.html</code> extension, if we don’t set them, then the server will
interpret them as <code class="highlighter-rouge">Content-Type: binary/octet-stream</code>. Other files
will get the correct <em>Content-Type</em>.</p>

<p>The
<a href="http://docs.aws.amazon.com/cli/latest/reference/s3/">Amazon S3 Command Line Interface</a> has
a special parameter to set the correct <em>Content-Type</em> for each file
when
<a href="http://docs.aws.amazon.com/cli/latest/reference/s3/cp.html">copying</a>
them: <kbd>aws s3 cp local_directory bucket-name --content-type
text/html</kbd></p>

<p>In this approach, we are going to copy the files without extension,
setting the right <em>Content-Type</em>, and then just copy the rest of the
files, leaving that task to the server.</p>

<h3 id="copy-files-without-extension">Copy files without extension</h3>

<p>Copy local files to the S3 bucket.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>aws s3 cp _site/ s3://cachedpage.co/ --content-type text/html --recursive --exclude <span class="s2">"*.*"</span>
</code></pre>
</div>

<p>or synchronize the directory with the S3 bucket <strong>checking file
difference by size</strong> not timestamps.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>aws s3 sync _site/ <span class="nv">$s3_bucket</span> --size-only --exclude <span class="s2">"*"</span> --include <span class="s2">"*.*"</span> --delete
</code></pre>
</div>

<p class="alert alert-info">As every time the website is built, Jekyll regenerates all the files,
so <em>timestamps</em> would always be different, checking file sizes would
only copy files if they are different.</p>

<h3 id="copy-the-rest-of-the-files">Copy the rest of the files</h3>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>aws s3 cp _site/ s3://cachedpage.co/ --recursive --exclude <span class="s2">"*"</span> --include <span class="s2">"*.*"</span>
</code></pre>
</div>

<p>or with <kbd>aws sync</kbd>:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>aws s3 sync _site/ <span class="nv">$s3_bucket</span> --size-only --content-type text/html --exclude <span class="s2">"*.*"</span> --delete
</code></pre>
</div>

<blockquote class="blockquote" cite="http://docs.aws.amazon.com/cli/latest/reference/s3/#use-of-exclude-and-include-filters">
  <p>Note that, by default, all files are included. This means that
providing only an –include filter will not change what files are
transferred. –include will only re-include files that have been
excluded from an –exclude filter. If you only want to upload files
with a particular extension, you need to first exclude all files,
then re-include the files with the particular extension.</p>

  <footer class="blockquote-footer"> <cite><a href="http://docs.aws.amazon.com/cli/latest/reference/s3/#use-of-exclude-and-include-filters">Use of Exclude and Include Filters</a></cite></footer>
</blockquote>

<h2 id="invalidate-uploaded-files-in-cloudfront">Invalidate uploaded files in Cloudfront</h2>

<p>If we are using a Content Delivery Network, chances are that your
files has been cached and you need to refresh them. To remove an
object from CloudFront edge caches before it expires we need to
<em>invalidate</em> them.</p>

<blockquote class="blockquote" cite="http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Invalidation.html">
  <p>The next time a viewer requests the object, CloudFront returns to
the origin to fetch the latest version of the object.</p>

  <footer class="blockquote-footer"> <cite><a href="http://docs.aws.amazon.com/cli/latest/reference/s3/#use-of-exclude-and-include-filters">Invalidating Objects (Web Distributions Only)</a></cite></footer>
</blockquote>

<p>For this we copy the modified file names to a temporal file, and then
create a new <strong>invalidation</strong> with these names as they are access in
our website.</p>

<blockquote class="blockquote" cite="http://docs.aws.amazon.com/cli/latest/reference/cloudfront/create-invalidation.html">
  <p>AWS CLI support for this service is only available in a preview
stage. You can enable this service by running: <code class="highlighter-rouge">aws configure set
preview.cloudfront true</code></p>

  <footer class="blockquote-footer"> <cite><a href="http://docs.aws.amazon.com/cli/latest/reference/s3/#use-of-exclude-and-include-filters">create-invalidation</a></cite></footer>
</blockquote>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nv">tempfile</span><span class="o">=</span><span class="k">$(</span>mktemp<span class="k">)</span>
<span class="nv">distribution_id</span><span class="o">=</span>ASDFHDFSAF45234
<span class="nb">echo</span> <span class="s2">"Copying files to server..."</span>
aws s3 sync _site/ <span class="k">$(</span>s3_bucket<span class="k">)</span> --size-only --exclude <span class="s2">"*"</span> --include <span class="s2">"*.*"</span> --delete | tee -a <span class="k">$(</span>tempfile<span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"Copying files with content type..."</span>
aws s3 sync _site/ <span class="k">$(</span>s3_bucket<span class="k">)</span> --size-only --content-type text/html --exclude <span class="s2">"*.*"</span> --delete | tee -a <span class="k">$(</span>tempfile<span class="k">)</span>
<span class="c">#invalidate only modified files</span>
grep <span class="s2">"upload</span><span class="se">\|</span><span class="s2">deleted"</span> <span class="k">$(</span>tempfile<span class="k">)</span> | sed -e <span class="s2">"s|.*upload.*to </span><span class="k">$(</span>s3_bucket<span class="k">)</span><span class="s2">|/|"</span> | sed -e <span class="s2">"s|.*delete: </span><span class="k">$(</span>s3_bucket<span class="k">)</span><span class="s2">|/|"</span> | sed -e <span class="s1">'s/index.html//'</span> | sed -e <span class="s1">'s/\(.*\).html/\1/'</span> | tr <span class="s1">'\n'</span> <span class="s1">' '</span> | xargs aws cloudfront create-invalidation --distribution-id <span class="k">$(</span>distribution_id<span class="k">)</span> --paths
</code></pre>
</div>

<h3 id="script-explanation">Script explanation:</h3>

<p>First we create the temporal file that will hold modified files with
<code class="highlighter-rouge">tempfile=$(mktemp)</code>.</p>

<p>Then we synchronize the local directory with the remote one in S3,
redirecting the output to standard output and to the temporal file
with:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>aws s3 sync _site/ $(s3_bucket) --size-only --exclude "*" --include "*.*" --delete | tee -a $(tempfile)
aws s3 sync _site/ $(s3_bucket) --size-only --content-type text/html --exclude "*.*" --delete | tee -a $(tempfile)
</code></pre>
</div>

<p>After that we process the file names that were uploaded or deleted by
the <code class="highlighter-rouge">aws</code> command:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>grep "upload\|deleted" $(tempfile) 
</code></pre>
</div>

<p>Then discard the string between <code class="highlighter-rouge">upload</code> or <code class="highlighter-rouge">delete</code> and the name of
the bucket:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sed -e "s|.*upload.*to $(s3_bucket)|/|" | sed -e "s|.*delete:
$(s3_bucket)|/|" 
</code></pre>
</div>

<p>As our URLs are accessed only with the URLs like <code class="highlighter-rouge">/</code> instead of
<code class="highlighter-rouge">/index.html</code> we remove them</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sed -e 's/index.html//' 
</code></pre>
</div>

<p>Our URLs doesn’t have the <code class="highlighter-rouge">.html</code> extension also:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sed -e 's/\(.*\).html/\1/' 
</code></pre>
</div>

<p>Lastly we put all the URLs like names in a single line separated with 
a space to comply with the <code class="highlighter-rouge">aws cloudfront create-invalidation
--paths</code> command:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>tr '\n' ' ' | xargs aws cloudfront create-invalidation --distribution-id $(distribution_id) --paths
</code></pre>
</div>

<h2 id="final-script">Final script</h2>

<p>The complete process is reflected in the following <code class="highlighter-rouge">deploy.sh</code> script,
you probably want to adapt it to a <code class="highlighter-rouge">Makefile</code>, <code class="highlighter-rouge">Grunt</code> or some other
program but I will leave it as a <code class="highlighter-rouge">bash</code> script to reflect its usage:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
<span class="c">#</span>
<span class="c"># Copy Jekyll site to S3 bucket</span>
<span class="c">#</span>
<span class="c">####################################</span>
<span class="c">#</span>
<span class="c"># Custom vars</span>
<span class="c">#</span>
<span class="nv">s3_bucket</span><span class="o">=</span><span class="s2">"s3://example.com/"</span>
<span class="nv">distribution_id</span><span class="o">=</span>ASDFHDFSAF45234
<span class="c">####################################</span>

<span class="nb">set</span> -e <span class="c"># halt script on error</span>
<span class="nb">set</span> -v <span class="c"># echo on</span>

<span class="nv">tempfile</span><span class="o">=</span><span class="k">$(</span>mktemp<span class="k">)</span>

<span class="nb">echo</span> <span class="s2">"Building site..."</span>
<span class="nv">JEKYLL_ENV</span><span class="o">=</span>production bundle <span class="nb">exec </span>jekyll build

<span class="nb">echo</span> <span class="s2">"Removing .html extension"</span>
find _site/ -type f ! -iname <span class="s1">'index.html'</span> -iname <span class="s1">'*.html'</span> -print0 | <span class="k">while </span><span class="nb">read</span> -d <span class="nv">$'</span><span class="se">\0</span><span class="s1">' f; do mv "$f" "${f%.html}"; done

echo "Copying files to server..."
aws s3 sync _site/ $(s3_bucket) --size-only --exclude "*" --include "*.*" --delete | tee -a $(tempfile)
echo "Copying files with content type..."
aws s3 sync _site/ $(s3_bucket) --size-only --content-type text/html --exclude "*.*" --delete | tee -a $(tempfile)
#invalidate only modified files
grep "upload\|deleted" $(tempfile) | sed -e "s|.*upload.*to $(s3_bucket)|/|" | sed -e "s|.*delete: $(s3_bucket)|/|" | sed -e '</span>s/index.html//<span class="s1">' | sed -e '</span>s/<span class="se">\(</span>.<span class="k">*</span><span class="se">\)</span>.html/<span class="se">\1</span>/<span class="s1">' | tr '</span><span class="se">\n</span><span class="s1">' '</span> <span class="s1">' | xargs aws cloudfront create-invalidation --distribution-id $(distribution_id) --paths
</span></code></pre>
</div>

<h2 id="conclusion">Conclusion</h2>

<p>This approach will work in most situations, you have to be careful if
you have any other files without extension to avoid setting the wrong
media type.</p>

<h2 id="references">References</h2>

<ul>
  <li>Index documents in
S3
<a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/IndexDocumentSupport.html">http://docs.aws.amazon.com/AmazonS3/latest/dev/IndexDocumentSupport.html</a></li>
  <li>Caching user input in bash <a href="http://tldp.org/LDP/Bash-Beginners-Guide/html/sect_08_02.html">http://tldp.org/LDP/Bash-Beginners-Guide/html/sect_08_02.html</a></li>
  <li><a href="http://stackoverflow.com/users/507519/thkala">thkala</a> answer in <a href="http://stackoverflow.com/a/4509530/1165509">Linux: remove file extensions for multiple files</a></li>
  <li>S3 cli docs <a href="http://docs.aws.amazon.com/cli/latest/reference/s3/">http://docs.aws.amazon.com/cli/latest/reference/s3/</a></li>
  <li>S3 Exclude and include
filters
<a href="http://docs.aws.amazon.com/cli/latest/reference/s3/index.html#use-of-exclude-and-include-filters">http://docs.aws.amazon.com/cli/latest/reference/s3/index.html#use-of-exclude-and-include-filters</a></li>
  <li>Complete list of MIME
types
<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Complete_list_of_MIME_types">https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Complete_list_of_MIME_types</a></li>
  <li>Content Type Header field <a href="https://www.w3.org/Protocols/rfc1341/4_Content-Type.html">https://www.w3.org/Protocols/rfc1341/4_Content-Type.html</a></li>
  <li>MIME media type name : Text <a href="https://www.iana.org/assignments/media-types/text/html">https://www.iana.org/assignments/media-types/text/html</a></li>
</ul>

<div class="footnotes">
  <ol>
    <li id="fn:contenttype">

      <p>The Content-Type entity header is used to indicate the media type
of the resource, a string sent in the headers of a file to
indicate its type</p>

      <blockquote class="blockquote" cite="https://www.w3.org/Protocols/rfc1341/4_Content-Type.html">
        <p>The purpose of the Content-Type field is to describe the data
contained in the body fully enough that the receiving user agent
can pick an appropriate agent or mechanism to present the data
to the user, or otherwise deal with the data in an appropriate
manner.</p>

        <footer class="blockquote-footer"> <cite><a href="https://www.w3.org/Protocols/rfc1341/4_Content-Type.html">The content type header field</a></cite></footer>
      </blockquote>
      <p><a href="#fnref:contenttype" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>


    



<footer class="author-footer">
    <div class="media" itemtype="https://schema.org/Person">
	<span itemprop="locationCreated contentLocation spatialCoverage" itemscope="itemscope" itemtype="https://schema.org/City" style="display:none"><span itemprop="name">Uruguay</span>
	</span>
	<link href="https://plus.google.com/118415138433063920612/posts" rel="author"/>
	<meta content="https://www.facebook.com/unix.root" property="article:author"/>
	<meta content="@marcanuy" name="twitter:creator"/>
	<meta content="https://plus.google.com/118415138433063920612/posts" name="DC.creator"/>
	<meta content="Marcelo Canina" name="author"/>
	
	<a class="media-left mx-2" href="https://marcanuy.com" itemprop="url" rel="author">
	    <img class="media-object rounded" alt="Marcelo Canina - Simple IT 🤘 Rocks" itemprop="image" src="https://www.gravatar.com/avatar/2ebdffd5ddb4a98b0cc77117503d2711?s=80"/>
	</a>
	<div class="media-body">
	    <h5 class="media-heading">
		<address class="author-info clear" id="author-info" itemprop="author creator" itemscope="" itemtype="https://schema.org/Person">
		    <span class="author-name" itemprop="name">Marcelo Canina</span>
		    <a class="a-social a-tw" href="https://twitter.com/marcanuy" itemprop="sameAs" target="_blank"><i class="fa fa-twitter-square"></i></a>
		    <a class="a-social a-gp" href="https://plus.google.com/118415138433063920612?rel=author" itemprop="url sameAs" rel="author" target="_blank"><i class="fa fa-google-plus-square"></i></a>
		    <a class="a-social a-ln" href="https://www.linkedin.com/in/marcelocanina" itemprop="sameAs" target="_blank"><i class="fa fa-linkedin-square"></i></a>
		    <a class="a-social a-email" href="mailto:me@marcanuy.com" itemprop="email sameAs" target="_blank"><i class="fa fa-envelope-o"></i></a>
		    <a class="a-social a-github" href="https://github.com/marcanuy" itemprop="github sameAs" target="_blank"><i class="fa fa-github"></i></a>
		    <a class="a-social a-stackexchange" href="https://stackexchange.com/users/1193189?tab=accounts" itemprop="stackexchange sameAs" target="_blank"><i class="fa fa-stack-exchange"></i></a>
		</address>
	    </h5>
	    <div class="text-muted">
		I'm Marcelo Canina, a developer from Uruguay. I build websites and web-based applications from the ground up and share what I learn here.
	    </div>
	</div>
    </div>
</footer>




    <div class="post-comments">
  

  <div id="disqus_thread"></div>
  <script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
    */
    /*
    var disqus_config = function () {
    this.page.url = '/having-pretty-urls-in-a-jekyll-website-hosted-in-amazon-s3/';  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = 'simpleitrocks'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    
    s.src = '//simpleitrocks.disqus.com/embed.js';
    
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  
  
  
</div>


    <div class="row">
      <div class="col-md-6">
	






<div class="post-same-category">
  <h4>Articles in this category</h4>
  <div class="list-group">

    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
      <a class="list-group-item list-group-item-action " href="/how-to-handle-adsense-in-a-jekyll-development-environment/">
      How To Handle Adsense In A Jekyll Development Environment
    </a>
    
    
    
    
    
    
      <a class="list-group-item list-group-item-action " href="/how-to-prevent-content-displaying-in-a-jekyll-development-environment/">
      How To Prevent Content Displaying In A Jekyll Development Environment
    </a>
    
    
    
    
    
    
      <a class="list-group-item list-group-item-action " href="/how-to-create-breadcrumbs-with-hierarchical-categories-in-jekyll/">
      How to implement breadcrumbs on a Jekyll site with nested categories
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
      <a class="list-group-item list-group-item-action " href="/how-to-use-bower-scss-with-jekyll/">
      How To Use Bower Scss With Jekyll
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
      <a class="list-group-item list-group-item-action " href="/automated-deployment-of-jekyll-websites-to-github-pages-with-a-git-push-to-github/">
      Automated Deployment Of Jekyll Websites To Github Pages With A Git Push To Github
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
      <a class="list-group-item list-group-item-action " href="/how-to-add-bootstrap-4-to-jekyll-the-right-way/">
      5 Steps To Add Bootstrap 4 To Jekyll The Right Way
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
      <a class="list-group-item list-group-item-action active" href="/having-pretty-urls-in-a-jekyll-website-hosted-in-amazon-s3/">
      Host a Jekyll Website With Pretty Urls In Amazon S3 and Cloudfront
    </a>
    
    
    
    
    
    
      <a class="list-group-item list-group-item-action " href="/multilingual-jekyll-without-plugins/">
      Multilingual Jekyll Without Plugins
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
  </div>
</div>


	




      </div>
      <div class="col-md-5">
	
	
	<div class="si-ad m-1 mx-auto">
  

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- simpleit_after_content -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-1912030305535489"
       data-ad-slot="5104001581"
       data-ad-format="auto"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>

  
</div>

	
      </div>
    </div>
  </div> <!-- end col -->
</div>


</div>

    </div>

    <footer class="container-fluid site-footer py-3">
    <div class="container">
	<div class="row justify-content-between align-items-center">
	    <div class="col-4">
		<h2 class="footer-heading text-muted">Simple IT 🤘 Rocks</h2>
		<ul class="footer-nav px-0">
		    <li>
			<i class="fa fa-keyboard-o" aria-hidden="true"></i>Coded by <a href="https://marcanuy.com" rel="author">Marcelo Canina</a>
		    </li>
		    
		    <li>
			<i class="fa fa-twitter" aria-hidden="true"></i><a href="https://twitter.com/simpleitrocks"><span class="username">simpleitrocks</span></a>

		    </li>
		    
		    <li>
			<i class="fa fa-user" aria-hidden="true"></i><a href="/about">About</a>
		    </li>
		    <li>
			<i class="fa fa-search" aria-hidden="true"></i><a href="/search">Search</a>
		    </li>
		</ul>
	    </div>
	    <div class="col-4">
		<div class="text-muted">
		    <p>Clutter-free software concepts. Written on the go.
</p>
		</div>
	    </div>
	</div>
    </div>
</footer>
<div class="si-license bg-inverse">
  <div class="text-muted text-sm-center">
    <small>
      Except as otherwise noted, the content of this page is licensed under
      <a rel="license" class="text-info" href="https://creativecommons.org/licenses/by-nc/4.0/">
	<i class="fa fa-creative-commons" aria-hidden="true"></i> BY-NC 4.0
      </a>
    </small>
  </div>
</div>

<script src="/assets/vendor/jquery.min.js"></script>
<script src="/assets/vendor/tether.min.js"></script>
<script src="/assets/vendor/bootstrap.min.js"></script>


  </body>

</html>
